name: Test WSL Tools on Ubuntu Versions

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: warning
          ignore_paths: |
            node_modules

  test-ubuntu:
    name: Test on Ubuntu ${{ matrix.ubuntu-version }}
    runs-on: ubuntu-${{ matrix.ubuntu-version }}
    strategy:
      fail-fast: false
      matrix:
        ubuntu-version: ['24.04', '22.04', '20.04']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod -R +x .

      - name: Check Ubuntu version
        run: |
          echo "Testing on Ubuntu $(lsb_release -rs)"
          lsb_release -a

      - name: Test utilities.sh can be sourced
        run: |
          set -e
          # Test that utilities.sh can be sourced without errors
          # We need to run as root or mock the root check
          sudo bash -c "source ./utilities.sh && echo 'utilities.sh loaded successfully'"

      - name: Verify main script syntax
        run: |
          bash -n wsl_tools
          echo "Main script syntax is valid"

      - name: Verify all script syntax
        run: |
          find . -name "*.sh" -type f -exec bash -n {} \;
          echo "All scripts have valid syntax"

      - name: Test utility functions
        run: |
          sudo bash -c '
          source ./utilities.sh
          
          # Test color functions
          pGreen "Testing green color"
          pBlue "Testing blue color"
          pRed "Testing red color"
          
          # Test message functions
          _success "Test success message"
          _error "Test error message"
          _info "Test info message"
          _arrow "Test arrow message"
          
          # Test OS detection
          if _isOsDebian; then
            echo "Debian OS detected correctly"
          else
            echo "ERROR: Should detect Debian/Ubuntu"
            exit 1
          fi
          
          echo "All utility functions work correctly"
          '

      - name: Test domain validation function
        run: |
          sudo bash -c '
          source ./utilities.sh
          
          # Test valid domains
          if is_Domain_Valid "example.com"; then
            echo "✓ example.com validated correctly"
          else
            echo "✗ example.com should be valid"
            exit 1
          fi
          
          if is_Domain_Valid "subdomain.example.com"; then
            echo "✓ subdomain.example.com validated correctly"
          else
            echo "✗ subdomain.example.com should be valid"
            exit 1
          fi
          
          # Test invalid domains
          if ! is_Domain_Valid "invalid_domain"; then
            echo "✓ invalid_domain rejected correctly"
          else
            echo "✗ invalid_domain should be invalid"
            exit 1
          fi
          
          if ! is_Domain_Valid "no-extension"; then
            echo "✓ no-extension rejected correctly"
          else
            echo "✗ no-extension should be invalid"
            exit 1
          fi
          
          echo "Domain validation tests passed"
          '

      - name: Test Ubuntu version check
        run: |
          sudo bash -c '
          # Mock the ubuntu_only function test
          source ./utilities.sh
          
          UBUNTU_VERSION="$(lsb_release -rs)"
          echo "Current Ubuntu version: $UBUNTU_VERSION"
          
          # The _ubuntu_only function should not fail on supported versions
          if [[ "$UBUNTU_VERSION" == "24.04" || "$UBUNTU_VERSION" == "22.04" || "$UBUNTU_VERSION" == "20.04" || "$UBUNTU_VERSION" == "18.04" ]]; then
            echo "✓ Running on supported Ubuntu version"
          else
            echo "⚠ Warning: Running on unsupported Ubuntu version for testing purposes"
          fi
          '

      - name: Test script structure
        run: |
          # Verify important files exist
          test -f wsl_tools || { echo "Main script missing"; exit 1; }
          test -f utilities.sh || { echo "utilities.sh missing"; exit 1; }
          test -f scripts/stack/install.sh || { echo "install.sh missing"; exit 1; }
          test -d scripts/nginx || { echo "nginx scripts directory missing"; exit 1; }
          test -d scripts/php || { echo "php scripts directory missing"; exit 1; }
          echo "All required files and directories exist"

      - name: Test vHost utilities
        run: |
          sudo bash -c '
          source ./utilities.sh
          
          # Create mock nginx directories for testing
          mkdir -p /tmp/test-nginx/sites-available
          mkdir -p /tmp/test-nginx/sites-enabled
          
          # Create some test vhost files
          touch /tmp/test-nginx/sites-available/test1.conf
          touch /tmp/test-nginx/sites-available/test2.conf
          
          echo "vHost utility functions are available"
          '

      - name: Verify no bash syntax errors in all scripts
        run: |
          #!/bin/bash
          set -e
          error_count=0
          
          while IFS= read -r script; do
            echo "Checking: $script"
            if ! bash -n "$script" 2>&1; then
              echo "❌ Syntax error in $script"
              ((error_count++))
            else
              echo "✓ $script is valid"
            fi
          done < <(find . -type f -name "*.sh")
          
          if [ $error_count -gt 0 ]; then
            echo "Found $error_count script(s) with syntax errors"
            exit 1
          fi
          
          echo "All scripts passed syntax validation"

  test-ubuntu-1804:
    name: Test on Ubuntu 18.04
    runs-on: ubuntu-20.04  # GitHub Actions doesn't support 18.04 anymore
    container:
      image: ubuntu:18.04
    
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git lsb-release

      - name: Checkout code
        uses: actions/checkout@v3  # v4 doesn't support 18.04

      - name: Make scripts executable
        run: chmod -R +x .

      - name: Check Ubuntu version
        run: |
          echo "Testing on Ubuntu $(lsb_release -rs)"
          lsb_release -a

      - name: Verify script syntax
        run: |
          bash -n wsl_tools
          find . -name "*.sh" -type f -exec bash -n {} \;
          echo "All scripts have valid syntax on Ubuntu 18.04"

  summary:
    name: Test Summary
    needs: [shellcheck, test-ubuntu, test-ubuntu-1804]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "ShellCheck: ${{ needs.shellcheck.result }}"
          echo "Ubuntu Tests: ${{ needs.test-ubuntu.result }}"
          echo "Ubuntu 18.04 Test: ${{ needs.test-ubuntu-1804.result }}"
          
          if [[ "${{ needs.shellcheck.result }}" == "failure" ]] || \
             [[ "${{ needs.test-ubuntu.result }}" == "failure" ]] || \
             [[ "${{ needs.test-ubuntu-1804.result }}" == "failure" ]]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed!"
          fi